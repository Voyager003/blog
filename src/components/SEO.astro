---
/**
 * SEO Component
 * 검색 엔진 최적화를 위한 메타 태그, Open Graph, Twitter Card, JSON-LD 지원
 */
import { type Locale, defaultLocale } from '../i18n/config';

interface Props {
    // 기본 메타 태그
    title: string;
    description: string;
    keywords?: string[];
    canonical?: string;
    lang?: Locale;

    // Open Graph / Social Media
    ogType?: 'website' | 'article' | 'profile';
    ogImage?: string;
    ogImageAlt?: string;

    // Twitter Card
    twitterCard?: 'summary' | 'summary_large_image';
    twitterCreator?: string;

    // Article specific (for blog posts)
    publishedTime?: Date;
    modifiedTime?: Date;
    author?: string;
    tags?: string[];
    section?: string;

    // Structured Data
    jsonLd?: object;

    // Indexing
    noindex?: boolean;
    nofollow?: boolean;
}

const {
    title,
    description,
    keywords = [],
    canonical,
    lang = defaultLocale,
    ogType = 'website',
    ogImage,
    ogImageAlt,
    twitterCard = 'summary_large_image',
    twitterCreator = '@cmiscm',
    publishedTime,
    modifiedTime,
    author = 'Wongi Rim',
    tags = [],
    section,
    jsonLd,
    noindex = false,
    nofollow = false,
} = Astro.props;

// Site configuration with dynamic locale
const siteConfig = {
    name: 'WONGI RIM',
    url: 'https://blog.cmiscm.com',
    locale: lang === 'ko' ? 'ko_KR' : 'en_US',
    alternateLocale: lang === 'ko' ? 'en_US' : 'ko_KR',
    twitterHandle: '@cmiscm',
    defaultImage: '/og-image.svg',
    defaultImageAlt: 'WONGI RIM - Creative Developer',
};

// Generate canonical URL
const canonicalURL = canonical
    ? new URL(canonical, siteConfig.url).href
    : new URL(Astro.url.pathname, siteConfig.url).href;

// Full title with site name
const fullTitle = title === siteConfig.name
    ? title
    : `${title} — ${siteConfig.name}`;

// OG Image URL
const ogImageURL = ogImage
    ? new URL(ogImage, siteConfig.url).href
    : new URL(siteConfig.defaultImage, siteConfig.url).href;

// Robots directive
const robotsContent = [
    noindex ? 'noindex' : 'index',
    nofollow ? 'nofollow' : 'follow',
].join(', ');

// JSON-LD for WebSite
const websiteJsonLd = {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: siteConfig.name,
    url: siteConfig.url,
    description: 'Creative Developer & Designer - Exploring the intersection of code and creativity',
    inLanguage: lang,
    author: {
        '@type': 'Person',
        name: author,
    },
};

// JSON-LD for Article (blog posts)
const articleJsonLd = ogType === 'article' ? {
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: title,
    description: description,
    image: ogImageURL,
    url: canonicalURL,
    inLanguage: lang,
    datePublished: publishedTime?.toISOString(),
    dateModified: modifiedTime?.toISOString() || publishedTime?.toISOString(),
    author: {
        '@type': 'Person',
        name: author,
        url: siteConfig.url,
    },
    publisher: {
        '@type': 'Organization',
        name: siteConfig.name,
        logo: {
            '@type': 'ImageObject',
            url: `${siteConfig.url}/favicon.svg`,
        },
    },
    mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': canonicalURL,
    },
    ...(section && { articleSection: section }),
    ...(tags.length > 0 && { keywords: tags.join(', ') }),
} : null;

// BreadcrumbList JSON-LD
const breadcrumbJsonLd = {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
        {
            '@type': 'ListItem',
            position: 1,
            name: 'Home',
            item: siteConfig.url,
        },
        ...(Astro.url.pathname !== '/' && Astro.url.pathname !== `/${lang}/` ? [{
            '@type': 'ListItem',
            position: 2,
            name: title,
            item: canonicalURL,
        }] : []),
    ],
};

// Combine all JSON-LD
const allJsonLd = jsonLd || (ogType === 'article' ? articleJsonLd : websiteJsonLd);
---

<!-- Primary Meta Tags -->
<title>{fullTitle}</title>
<meta name="title" content={fullTitle} />
<meta name="description" content={description} />
{keywords.length > 0 && <meta name="keywords" content={keywords.join(', ')} />}
<meta name="author" content={author} />
<meta name="robots" content={robotsContent} />
<link rel="canonical" href={canonicalURL} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={ogType} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImageURL} />
{ogImageAlt && <meta property="og:image:alt" content={ogImageAlt || title} />}
<meta property="og:site_name" content={siteConfig.name} />
<meta property="og:locale" content={siteConfig.locale} />
<meta property="og:locale:alternate" content={siteConfig.alternateLocale} />

<!-- Article specific Open Graph -->
{ogType === 'article' && publishedTime && (
    <meta property="article:published_time" content={publishedTime.toISOString()} />
)}
{ogType === 'article' && modifiedTime && (
    <meta property="article:modified_time" content={modifiedTime.toISOString()} />
)}
{ogType === 'article' && author && (
    <meta property="article:author" content={author} />
)}
{ogType === 'article' && section && (
    <meta property="article:section" content={section} />
)}
{ogType === 'article' && tags.map(tag => (
    <meta property="article:tag" content={tag} />
))}

<!-- Twitter Card -->
<meta name="twitter:card" content={twitterCard} />
<meta name="twitter:url" content={canonicalURL} />
<meta name="twitter:title" content={fullTitle} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={ogImageURL} />
{twitterCreator && <meta name="twitter:creator" content={twitterCreator} />}
<meta name="twitter:site" content={siteConfig.twitterHandle} />

<!-- JSON-LD Structured Data -->
{allJsonLd && (
    <script type="application/ld+json" set:html={JSON.stringify(allJsonLd)} />
)}
<script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />

<!-- Additional SEO Meta Tags -->
<meta name="theme-color" content="#ffffff" />
<meta name="msapplication-TileColor" content="#ffffff" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link rel="alternate" type="application/rss+xml" title={`${siteConfig.name} RSS Feed`} href="/rss.xml" />
