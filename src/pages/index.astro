---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getCollection, render } from "astro:content";
import { type Locale } from "../i18n/config";
import { useTranslations, formatDate, formatDateShort } from "../i18n/utils";

const lang: Locale = 'ko';
const t = useTranslations(lang);

// Filter posts by language (from folder structure: en/post-name or ko/post-name)
const allPosts = await getCollection("posts", ({ id, data }) => {
    const postLang = id.startsWith('ko/') ? 'ko' : 'en';
    return postLang === lang && data.draft !== true;
});

// Sort by date and remove lang prefix from slug
const sortedPosts = allPosts
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
    .map(post => ({
        ...post,
        slug: post.id.replace(/^(ko|en)\//, ''),
    }));

// Prepare posts with Content
const posts = await Promise.all(sortedPosts.map(async (post) => {
    const { Content } = await render(post);
    return { ...post, Content };
}));
---

<Layout
    title="ROME"
    description="크리에이티브 코딩, WebGL, 머신러닝, 인터랙티브 디자인에 관한 글. 개발 노트, 튜토리얼, 프로젝트 인사이트."
    keywords={['blog', 'creative coding', 'webgl', 'tutorials', 'development', 'machine learning', 'interactive design']}
    lang={lang}
>
    <Header lang={lang} />
    <main class="w-full max-w-[800px] mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
        <!-- Posts List -->
        <div class="flex flex-col gap-16" id="posts-list">
            {posts.map((post, index) => (
                <article
                    class="group pb-16 border-b border-[var(--color-border-light)] post-item"
                    style={`animation-delay: ${index * 0.05}s`}
                >
                    <!-- Post Header -->
                    <header class="mb-8">
                        <!-- Category & Date -->
                        <div class="flex items-center gap-4 mb-4">
                            <span class="text-[11px] uppercase tracking-wider text-[var(--color-accent)]">
                                {post.data.category}
                            </span>
                            <span class="text-[var(--color-border)]">|</span>
                            <time
                                datetime={post.data.date.toISOString()}
                                class="text-[12px] text-[var(--color-text-tertiary)]"
                            >
                                {formatDate(post.data.date, lang)}
                            </time>
                        </div>

                        <!-- Title -->
                        <a href={`/blog/${post.slug}`} class="block group-hover:text-[var(--color-accent)] transition-colors">
                            <h2 class="text-[28px] sm:text-[32px] font-light leading-tight mb-6" style="font-family: var(--font-serif)">
                                {post.data.title}
                            </h2>
                        </a>

                        <!-- Cover Image -->
                        {post.data.cover && (
                            <div class="mt-6 aspect-video overflow-hidden">
                                <img
                                    src={post.data.cover.src}
                                    alt={post.data.title}
                                    class="w-full h-full object-cover"
                                />
                            </div>
                        )}
                    </header>

                    <!-- Post Content -->
                    <div class="prose prose-lg max-w-none mb-8">
                        <post.Content />
                    </div>

                    <!-- Footer / Comment Link -->
                    <div class="flex justify-end">
                        <a 
                            href={`/blog/${post.slug}#comments`}
                            class="text-[12px] text-[var(--color-text-secondary)] hover:text-[var(--color-accent)] transition-colors"
                        >
                            Comment
                        </a>
                    </div>
                </article>
            ))}
        </div>
    </main>
    <Footer lang={lang} />
</Layout>
