---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import TableOfContents from "../../../components/TableOfContents.astro";
import BackToTop from "../../../components/BackToTop.astro";
import Comments from "../../../components/Comments.astro";
import { getCollection, render } from "astro:content";
import { type Locale } from "../../../i18n/config";
import { useTranslations, formatDate, formatDateShort } from "../../../i18n/utils";

const lang: Locale = 'en';

export async function getStaticPaths() {
    const posts = await getCollection("posts", ({ data }) => data.draft !== true);

    // Only get English posts
    const enPosts = posts.filter(post => post.id.startsWith('en/'));

    return enPosts.map((post) => {
        const slug = post.id.replace(/^en\//, '');

        // Get sorted posts for this language to find prev/next
        const langPosts = enPosts
            .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

        const index = langPosts.findIndex(p => p.id === post.id);
        const prevPost = langPosts[index + 1] || null;
        const nextPost = langPosts[index - 1] || null;

        return {
            params: { slug },
            props: { post, prevPost, nextPost },
        };
    });
}

const { slug } = Astro.params;
const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);
const t = useTranslations(lang);

// Helper to get slug without lang prefix
function getPostSlug(post: { id: string }) {
    return post.id.replace(/^(ko|en)\//, '');
}

// OG Image URL
const ogImage = post.data.cover?.src || '/og-image.svg';
---

<Layout
    title={post.data.title}
    description={post.data.excerpt || `${post.data.title} - Blog post by Wongi Rim`}
    keywords={post.data.tags}
    ogType="article"
    ogImage={ogImage}
    publishedTime={post.data.date}
    modifiedTime={post.data.updatedDate}
    tags={post.data.tags}
    section={post.data.category}
    lang={lang}
>
    <Header lang={lang} />

    <!-- Table of Contents -->
    <TableOfContents headings={headings} />

    <main class="w-full max-w-[800px] mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
        <article>
            <!-- Post Header -->
            <header class="mb-12 pb-8 border-b border-[var(--color-border-light)]">
                <!-- Category & Date -->
                <div class="flex items-center gap-4 mb-6">
                    <a
                        href={`/en/blog?category=${post.data.category}`}
                        class="text-[11px] uppercase tracking-wider text-[var(--color-accent)] hover:underline"
                    >
                        {post.data.category}
                    </a>
                    <span class="text-[var(--color-border)]">|</span>
                    <time
                        datetime={post.data.date.toISOString()}
                        class="text-[12px] text-[var(--color-text-tertiary)]"
                    >
                        {formatDate(post.data.date, lang)}
                    </time>
                    {post.data.updatedDate && (
                        <>
                            <span class="text-[var(--color-border)]">|</span>
                            <span class="text-[11px] text-[var(--color-text-tertiary)]">
                                {t('blog.updated')}: {formatDateShort(post.data.updatedDate, lang)}
                            </span>
                        </>
                    )}
                </div>

                <!-- Title -->
                <h1 class="text-[32px] sm:text-[40px] font-light leading-tight mb-6" style="font-family: var(--font-serif)">
                    {post.data.title}
                </h1>

                <!-- Excerpt -->
                {post.data.excerpt && (
                    <p class="text-[16px] leading-relaxed text-[var(--color-text-secondary)] mb-6">
                        {post.data.excerpt}
                    </p>
                )}

                <!-- Tags -->
                {post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                        {post.data.tags.map(tag => (
                            <a
                                href={`/en/blog?tag=${tag}`}
                                class="text-[11px] px-3 py-1 bg-[var(--color-border-light)] text-[var(--color-text-secondary)] hover:bg-[var(--color-border)] hover:text-[var(--color-text)] transition-colors"
                            >
                                #{tag}
                            </a>
                        ))}
                    </div>
                )}

                <!-- Cover Image -->
                {post.data.cover && (
                    <div class="mt-8 aspect-video overflow-hidden">
                        <img
                            src={post.data.cover.src}
                            alt={post.data.title}
                            class="w-full h-full object-cover"
                        />
                    </div>
                )}
            </header>

            <!-- Post Content -->
            <div class="prose prose-lg max-w-none">
                <Content />
            </div>

            <!-- Previous/Next Navigation -->
            <nav class="mt-16 pt-8 border-t border-[var(--color-border-light)]">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    {prevPost ? (
                        <a
                            href={`/en/blog/${getPostSlug(prevPost)}`}
                            class="group flex flex-col p-4 border border-[var(--color-border-light)] hover:border-[var(--color-border)] transition-colors"
                        >
                            <span class="text-[11px] text-[var(--color-text-tertiary)] uppercase tracking-wider mb-2">
                                {t('blog.previous')}
                            </span>
                            <span class="text-[14px] text-[var(--color-text)] group-hover:text-[var(--color-accent)] transition-colors line-clamp-2" style="font-family: var(--font-serif)">
                                {prevPost.data.title}
                            </span>
                        </a>
                    ) : <div />}

                    {nextPost ? (
                        <a
                            href={`/en/blog/${getPostSlug(nextPost)}`}
                            class="group flex flex-col p-4 border border-[var(--color-border-light)] hover:border-[var(--color-border)] transition-colors sm:text-right"
                        >
                            <span class="text-[11px] text-[var(--color-text-tertiary)] uppercase tracking-wider mb-2">
                                {t('blog.next')}
                            </span>
                            <span class="text-[14px] text-[var(--color-text)] group-hover:text-[var(--color-accent)] transition-colors line-clamp-2" style="font-family: var(--font-serif)">
                                {nextPost.data.title}
                            </span>
                        </a>
                    ) : <div />}
                </div>
            </nav>

            <!-- Post Footer -->
            <footer class="mt-8 pt-8 border-t border-[var(--color-border-light)]">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <a
                        href="/en/blog"
                        class="text-[14px] text-[var(--color-text-secondary)] hover:text-[var(--color-accent)] transition-colors"
                    >
                        {t('blog.backToBlog')}
                    </a>
                    <div class="flex gap-4">
                        <span class="text-[12px] text-[var(--color-text-tertiary)]">{t('blog.share')}:</span>
                        <a
                            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(Astro.url.href)}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-[12px] text-[var(--color-text-secondary)] hover:text-[var(--color-accent)] transition-colors"
                        >
                            Twitter
                        </a>
                        <a
                            href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url.href)}&title=${encodeURIComponent(post.data.title)}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-[12px] text-[var(--color-text-secondary)] hover:text-[var(--color-accent)] transition-colors"
                        >
                            LinkedIn
                        </a>
                    </div>
                </div>
            </footer>

            <!-- Comments -->
            <Comments title={post.data.title} />
        </article>
    </main>
    <Footer lang={lang} />
    <BackToTop />
</Layout>

<style is:global>
    /* Prose styles for markdown content */
    .prose {
        color: var(--color-text);
        font-family: var(--font-mono);
        font-size: 15px;
        line-height: 1.8;
    }

    .prose h1 {
        font-family: var(--font-serif);
        font-size: 32px;
        font-weight: 400;
        margin-top: 48px;
        margin-bottom: 24px;
        line-height: 1.3;
    }

    .prose h2 {
        font-family: var(--font-serif);
        font-size: 24px;
        font-weight: 400;
        margin-top: 40px;
        margin-bottom: 16px;
        line-height: 1.3;
    }

    .prose h3 {
        font-family: var(--font-serif);
        font-size: 20px;
        font-weight: 400;
        margin-top: 32px;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .prose p {
        margin-bottom: 24px;
    }

    .prose a {
        color: var(--color-accent);
        text-decoration: underline;
        text-underline-offset: 2px;
    }

    .prose a:hover {
        text-decoration: none;
    }

    .prose strong {
        font-weight: 600;
        color: var(--color-text);
    }

    .prose em {
        font-style: italic;
    }

    .prose ul, .prose ol {
        margin-bottom: 24px;
        padding-left: 24px;
    }

    .prose ul {
        list-style-type: disc;
    }

    .prose ol {
        list-style-type: decimal;
    }

    .prose li {
        margin-bottom: 8px;
    }

    .prose li::marker {
        color: var(--color-text-tertiary);
    }

    .prose blockquote {
        border-left: 3px solid var(--color-accent);
        padding-left: 20px;
        margin: 24px 0;
        color: var(--color-text-secondary);
        font-style: italic;
    }

    .prose code {
        font-family: var(--font-mono);
        font-size: 13px;
        background: var(--color-border-light);
        color: var(--color-text);
        padding: 2px 6px;
        border-radius: 2px;
    }

    :root[data-theme="dark"] .prose code {
        background: #2d2d2d;
        color: #e0e0e0;
    }

    /* Code block with copy button */
    .prose pre {
        position: relative;
        background: var(--color-code-bg, #1a1a1a);
        color: #e0e0e0;
        padding: 20px;
        overflow-x: auto;
        margin: 24px 0;
        border-radius: 0;
    }

    .prose pre code {
        background: transparent;
        padding: 0;
        font-size: 13px;
        line-height: 1.6;
    }

    /* Copy button styles */
    .copy-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px 10px;
        font-size: 11px;
        font-family: var(--font-mono);
        background: rgba(255, 255, 255, 0.1);
        color: #999;
        border: none;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s, background 0.2s, color 0.2s;
    }

    .prose pre:hover .copy-button {
        opacity: 1;
    }

    .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
    }

    .copy-button.copied {
        color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
    }

    .prose img {
        max-width: 100%;
        height: auto;
        margin: 24px 0;
    }

    .prose hr {
        border: none;
        border-top: 1px solid var(--color-border-light);
        margin: 40px 0;
    }

    .prose table {
        width: 100%;
        border-collapse: collapse;
        margin: 24px 0;
        font-size: 14px;
    }

    .prose th, .prose td {
        border: 1px solid var(--color-border);
        padding: 12px;
        text-align: left;
    }

    .prose th {
        background: var(--color-border-light);
        font-weight: 500;
    }

    /* Task list styles */
    .prose ul:has(input[type="checkbox"]) {
        list-style: none;
        padding-left: 0;
    }

    .prose input[type="checkbox"] {
        margin-right: 8px;
    }

    /* Shiki light/dark theme switching */
    .prose pre {
        position: relative;
        background: var(--color-code-bg, #1a1a1a) !important;
        padding: 20px;
        overflow-x: auto;
        margin: 24px 0;
        border-radius: 0;
    }

    :root:not([data-theme="dark"]) .prose pre {
        background: #f6f8fa !important;
    }

    :root:not([data-theme="dark"]) .prose pre code {
        color: #24292e;
    }

    :root:not([data-theme="dark"]) .shiki.github-dark {
        display: none !important;
    }

    :root[data-theme="dark"] .shiki.github-light {
        display: none !important;
    }

    /* Footnotes */
    .prose .footnotes {
        margin-top: 48px;
        padding-top: 24px;
        border-top: 1px solid var(--color-border-light);
        font-size: 13px;
    }

    .prose .footnotes h2 {
        font-size: 14px;
        margin-bottom: 16px;
    }

    .prose .footnotes ol {
        padding-left: 20px;
    }

    .prose .footnotes li {
        margin-bottom: 12px;
        color: var(--color-text-secondary);
    }

    .prose .footnotes li p {
        margin: 0;
        display: inline;
    }

    .prose sup a[data-footnote-ref] {
        font-size: 11px;
        color: var(--color-accent);
        text-decoration: none;
        padding: 0 2px;
    }

    .prose sup a[data-footnote-ref]:hover {
        text-decoration: underline;
    }

    .prose a[data-footnote-backref] {
        font-size: 11px;
        color: var(--color-accent);
        text-decoration: none;
        margin-left: 4px;
    }

    .prose a[data-footnote-backref]:hover {
        text-decoration: underline;
    }

    .prose del {
        color: var(--color-text-tertiary);
    }
</style>

<script>
    // Code copy button functionality
    function initCopyButtons() {
        const codeBlocks = document.querySelectorAll('.prose pre');

        codeBlocks.forEach((block) => {
            if (block.querySelector('.copy-button')) return;

            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            button.setAttribute('aria-label', 'Copy code to clipboard');

            button.addEventListener('click', async () => {
                const code = block.querySelector('code');
                if (!code) return;

                try {
                    await navigator.clipboard.writeText(code.textContent || '');
                    button.textContent = 'Copied!';
                    button.classList.add('copied');

                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    button.textContent = 'Failed';
                    setTimeout(() => {
                        button.textContent = 'Copy';
                    }, 2000);
                }
            });

            block.appendChild(button);
        });
    }

    initCopyButtons();
    document.addEventListener('astro:after-swap', initCopyButtons);
</script>
